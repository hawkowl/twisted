#!/bin/bash
#
# Helper to run predefined test suites.
#

COMMAND=$1

# Run minimal report to reduce log size.
TRIAL_COMMAND="./bin/trial --reporter=text --unclean-warnings"
PYTHON_3_TEST="./admin/run-python3-tests"

REQUIREMENTS="\
    pyOpenSSL==0.14 \
    service-identity==0.2 \
    pycrypto==2.6.1 \
    pyasn1==0.1.7 \
    "

#
# Install project and dependencies with pip.
#
pip_install_dependencies() {
    pip install .
    pip install $REQUIREMENTS
    # Removed compiled python files.
    find . -name "*.pyc" -or -name "*$py.class" | xargs rm -f
}


#
# Run trial inside the virtual environment.
#
run_venv_trial() {
    pip_install_dependencies
    echo "Running tests $@..."
    python $TRIAL_COMMAND $@
    exit_code=$?
    return $exit_code
}


#
# Run trial on using system Python.
#
run_system_trial() {
    echo "Updating packages..."
    sudo apt-get update -qq

    echo "Installing dependencies..."
    sudo apt-get install -qq python-gtk2 python-gobject

    echo "Running tests $@..."
    /usr/bin/python $TRIAL_COMMAND $@
    exit_code=$?

    return $exit_code
}


case "$COMMAND" in
    "py-default")
        run_venv_trial twisted
        ;;

    "py-without-modules")
        run_venv_trial --without-module OpenSSL --without-module Crypto twisted
        ;;

    "py-select-gc")
        run_venv_trial --force-gc --reactor=select twisted.internet
        ;;

    "py-select")
        run_venv_trial --reactor=select twisted.internet
        ;;

    "py-poll")
        run_venv_trial --reactor=poll twisted.internet
        ;;

    "py-epoll")
        run_venv_trial --reactor=epoll twisted.internet
        ;;

    "py-glib2")
        run_system_trial --reactor=glib2 twisted.internet
        ;;

    "py-gi")
        run_system_trial --reactor=gi twisted.internet
        ;;

    "py-gtk2")
        run_system_trial --reactor=gtk2 twisted.internet
        ;;

    "py-gtk3")
        run_system_trial --reactor=gtk3 twisted.internet
        ;;

    "py-3.3")
        pip_install_dependencies
        python3.3 $PYTHON_3_TEST
        exit_code=$?
        exit $exit_code
        ;;

    "pyflakes")
        pip install pyflakes==0.8.1
        pyflakes twisted
        ;;

    "twistedchecker")
        pip install pep8==1.5.1 twistedchecker==0.2.0
        twistedchecker twisted
        ;;

    "documentation")
        pip install . sphinx==1.2.1
        python ./bin/admin/build-docs . doc/core/howto/template.
        ;;

    "api-reference")
        pip install pydoctor==0.5
        python ./bin/admin/build-apidocs . apidocs
        ;;

    *)
        echo "Unknown command $COMMAND"
        exit 1
esac

exit $?
